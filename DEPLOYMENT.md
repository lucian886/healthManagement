# å¥åº·ç®¡ç†ç³»ç»Ÿ - éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
- [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [è¿ç»´å‘½ä»¤](#è¿ç»´å‘½ä»¤)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼ŒåŒ…å«ä¸‰ä¸ªç‹¬ç«‹æœåŠ¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·è®¿é—®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Frontend (80)   â”‚  React + Vite + Nginx
           â”‚   å‰ç«¯æœåŠ¡         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
        â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Backend (8081)â”‚           â”‚AI-Service    â”‚  FastAPI + é€šä¹‰åƒé—®
â”‚ åç«¯æœåŠ¡      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (8001)      â”‚
â”‚Spring Boot   â”‚           â”‚AI æ™ºèƒ½ä½“æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL  â”‚  (å¤–éƒ¨æ•°æ®åº“)
â”‚   æ•°æ®åº“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡è¯´æ˜

- **Frontend (ç«¯å£ 80)**: React å‰ç«¯åº”ç”¨ï¼Œä½¿ç”¨ Nginx æ‰˜ç®¡é™æ€æ–‡ä»¶
- **Backend (ç«¯å£ 8081)**: Spring Boot åç«¯æœåŠ¡ï¼Œæä¾› REST API
- **AI-Service (ç«¯å£ 8001)**: Python FastAPI AI æ™ºèƒ½ä½“æœåŠ¡

## ğŸ”§ å‰ç½®è¦æ±‚

### æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 20.04+, CentOS 7+)
- **å†…å­˜**: è‡³å°‘ 4GB RAM (æ¨è 8GB+)
- **ç£ç›˜**: è‡³å°‘ 20GB å¯ç”¨ç©ºé—´
- **CPU**: 2æ ¸ä»¥ä¸Š

### è½¯ä»¶è¦æ±‚

1. **Docker** (20.10+)
2. **Docker Compose** (1.29+)
3. **Git** (ç”¨äºæ‹‰å–ä»£ç )

### å®‰è£… Docker (Ubuntu/Debian)

```bash
# æ›´æ–°åŒ…ç´¢å¼•
sudo apt-get update

# å®‰è£…ä¾èµ–
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# æ·»åŠ  Docker å®˜æ–¹ GPG key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# è®¾ç½®ç¨³å®šç‰ˆä»“åº“
echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# å®‰è£… Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
docker compose version
```

### å®‰è£… Docker (CentOS/RHEL)

```bash
# å®‰è£…ä¾èµ–
sudo yum install -y yum-utils

# æ·»åŠ  Docker ä»“åº“
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# å®‰è£… Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
docker compose version
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. å…‹éš†ä»£ç 

```bash
# å…‹éš†ä»“åº“
git clone <your-repository-url> health-management
cd health-management
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥çœŸå®é…ç½®
nano .env
```

éœ€è¦é…ç½®çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# é€šä¹‰åƒé—® API Key (å¿…å¡«)
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx

# é˜¿é‡Œäº‘ OSS é…ç½® (å¿…å¡«)
ALIYUN_OSS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxxxx
ALIYUN_OSS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 3. è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x deploy.sh

# æ‰§è¡Œéƒ¨ç½²
./deploy.sh
```

é€‰æ‹© **é€‰é¡¹ 1 - å…¨æ–°éƒ¨ç½²**ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š

1. æ„å»º Docker é•œåƒ
2. å¯åŠ¨æ‰€æœ‰æœåŠ¡
3. æ‰§è¡Œå¥åº·æ£€æŸ¥

### 4. éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®ï¼š

- **å‰ç«¯åº”ç”¨**: http://your-server-ip
- **åç«¯ API**: http://your-server-ip:8081
- **AI æœåŠ¡**: http://your-server-ip:8001

## ğŸ“ è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
./deploy.sh
```

è„šæœ¬æä¾›ä»¥ä¸‹é€‰é¡¹ï¼š

1. **å…¨æ–°éƒ¨ç½²** - é¦–æ¬¡éƒ¨ç½²æˆ–å®Œå…¨é‡å»º
2. **é‡å¯æœåŠ¡** - å¿«é€Ÿé‡å¯æ‰€æœ‰æœåŠ¡
3. **æ›´æ–°å¹¶é‡å¯** - ä»£ç æ›´æ–°åé‡æ–°æ„å»º
4. **åœæ­¢æ‰€æœ‰æœåŠ¡** - åœæ­¢å¹¶ç§»é™¤å®¹å™¨
5. **æŸ¥çœ‹æœåŠ¡çŠ¶æ€** - æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€
6. **æŸ¥çœ‹æ—¥å¿—** - æŸ¥çœ‹æœåŠ¡æ—¥å¿—

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨ä½¿ç”¨ Docker Compose

#### 1. æ„å»ºé•œåƒ

```bash
docker-compose build
```

#### 2. å¯åŠ¨æœåŠ¡

```bash
# åå°å¯åŠ¨
docker-compose up -d

# å‰å°å¯åŠ¨ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
docker-compose up
```

#### 3. æŸ¥çœ‹çŠ¶æ€

```bash
docker-compose ps
```

#### 4. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f ai-service
docker-compose logs -f frontend
```

#### 5. åœæ­¢æœåŠ¡

```bash
# åœæ­¢æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®å·
docker-compose down -v
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆä» `env.example` å¤åˆ¶ï¼‰ï¼š

```bash
# å¿…å¡«é…ç½®
DASHSCOPE_API_KEY=your_api_key          # é€šä¹‰åƒé—® API Key
ALIYUN_OSS_ACCESS_KEY_ID=your_key_id    # é˜¿é‡Œäº‘ OSS Access Key ID
ALIYUN_OSS_ACCESS_KEY_SECRET=your_secret # é˜¿é‡Œäº‘ OSS Access Key Secret
```

### æ•°æ®åº“é…ç½®

æ•°æ®åº“é…ç½®åœ¨ `backend/src/main/resources/application-prod.yml` ä¸­ï¼š

```yaml
spring:
  datasource:
    url: jdbc:postgresql://47.94.41.55:5432/health_db
    username: health_user
    password: Health@2024
```

**æ³¨æ„**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿®æ”¹æ•°æ®åº“å¯†ç å¹¶ä½¿ç”¨ç¯å¢ƒå˜é‡ã€‚

### ç«¯å£é…ç½®

é»˜è®¤ç«¯å£é…ç½®ï¼š

- Frontend: `80`
- Backend: `8081`
- AI Service: `8001`

å¦‚éœ€ä¿®æ”¹ç«¯å£ï¼Œç¼–è¾‘ `docker-compose.yml`ï¼š

```yaml
services:
  frontend:
    ports:
      - "8080:80"  # ä¿®æ”¹ä¸º 8080:80
```

### Nginx é…ç½®

å‰ç«¯ Nginx é…ç½®æ–‡ä»¶ï¼š`frontend/nginx.conf`

- æ”¯æŒ SPA è·¯ç”±
- API ä»£ç†åˆ°åç«¯
- é™æ€èµ„æºç¼“å­˜
- Gzip å‹ç¼©

## ğŸ” å¥åº·æ£€æŸ¥

### è‡ªåŠ¨å¥åº·æ£€æŸ¥

Docker Compose é…ç½®äº†è‡ªåŠ¨å¥åº·æ£€æŸ¥ï¼š

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

### æ‰‹åŠ¨æ£€æŸ¥

```bash
# AI æœåŠ¡
curl http://localhost:8001/health

# åç«¯æœåŠ¡
curl http://localhost:8081/api/auth/health

# å‰ç«¯æœåŠ¡
curl http://localhost/health
```

## ğŸ› ï¸ è¿ç»´å‘½ä»¤

### å¯åŠ¨/åœæ­¢æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose stop

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart backend
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f backend

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose logs --tail=100 ai-service
```

### è¿›å…¥å®¹å™¨

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker-compose exec backend bash

# è¿›å…¥ AI æœåŠ¡å®¹å™¨
docker-compose exec ai-service bash

# è¿›å…¥å‰ç«¯å®¹å™¨
docker-compose exec frontend sh
```

### æ›´æ–°æœåŠ¡

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æˆ–ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./deploy.sh  # é€‰æ‹©é€‰é¡¹ 3
```

### æ¸…ç†èµ„æº

```bash
# åˆ é™¤åœæ­¢çš„å®¹å™¨
docker-compose rm

# åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# åˆ é™¤æœªä½¿ç”¨çš„æ•°æ®å·
docker volume prune

# å®Œå…¨æ¸…ç†
docker system prune -a --volumes
```

## â“ å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :80
sudo lsof -i :8081
sudo lsof -i :8001

# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
```

### 2. å†…å­˜ä¸è¶³

```bash
# å¢åŠ  Docker å†…å­˜é™åˆ¶
docker-compose.yml ä¸­æ·»åŠ ï¼š
services:
  backend:
    mem_limit: 2g
```

### 3. æ„å»ºå¤±è´¥

```bash
# æ¸…ç† Docker ç¼“å­˜é‡æ–°æ„å»º
docker-compose build --no-cache

# æ£€æŸ¥ Dockerfile å’Œä¾èµ–æ–‡ä»¶
```

### 4. æœåŠ¡æ— æ³•è¿æ¥

```bash
# æ£€æŸ¥ Docker ç½‘ç»œ
docker network ls
docker network inspect health-network

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs -f
```

### 5. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“é…ç½®
cat backend/src/main/resources/application-prod.yml

# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker-compose exec backend bash
apt-get update && apt-get install -y postgresql-client
psql -h 47.94.41.55 -U health_user -d health_db
```

### 6. AI æœåŠ¡è°ƒç”¨å¤±è´¥

```bash
# æ£€æŸ¥ API Key é…ç½®
docker-compose exec ai-service env | grep DASHSCOPE

# æµ‹è¯• AI æœåŠ¡
curl http://localhost:8001/health
```

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: ä¿®æ”¹æ•°æ®åº“å¯†ç å’Œ JWT Secret
2. **ä½¿ç”¨ HTTPS**: é…ç½® SSL è¯ä¹¦ï¼ˆæ¨èä½¿ç”¨ Let's Encryptï¼‰
3. **é˜²ç«å¢™é…ç½®**: åªå¼€æ”¾å¿…è¦ç«¯å£ï¼ˆ80, 443ï¼‰
4. **å®šæœŸæ›´æ–°**: åŠæ—¶æ›´æ–°ç³»ç»Ÿå’Œ Docker é•œåƒ
5. **å¤‡ä»½æ•°æ®**: å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œä¸Šä¼ æ–‡ä»¶

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ä½ç½®

- **å‰ç«¯æ—¥å¿—**: `docker-compose logs frontend`
- **åç«¯æ—¥å¿—**: `docker-compose logs backend`
- **AI æœåŠ¡æ—¥å¿—**: `docker-compose logs ai-service`

### æŒä¹…åŒ–æ—¥å¿—

ç¼–è¾‘ `docker-compose.yml` æ·»åŠ æ—¥å¿—å·ï¼š

```yaml
services:
  backend:
    volumes:
      - ./logs/backend:/app/logs
```

## ğŸŒ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 1. ä½¿ç”¨ Nginx åå‘ä»£ç†

åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Nginx ä½œä¸ºç»Ÿä¸€å…¥å£ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:80;
    }

    location /api/ {
        proxy_pass http://localhost:8081;
    }
}
```

### 2. é…ç½® SSL

```bash
# ä½¿ç”¨ Certbot ç”³è¯·è¯ä¹¦
sudo certbot --nginx -d your-domain.com
```

### 3. æ€§èƒ½ä¼˜åŒ–

- å¯ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
- é…ç½® Redis ç¼“å­˜
- æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- å¯ç”¨ Gzip å‹ç¼©

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ—¥å¿—: `docker-compose logs -f`
2. æ£€æŸ¥æœåŠ¡çŠ¶æ€: `docker-compose ps`
3. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†

---

æœ€åæ›´æ–°: 2024-12-23




